<%- include("../layouts/boilerplate") %>

<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <h3 class="text-center mb-4">
        Edit Registration â€“ <%= event.eventName %>
      </h3>

      <form
        action="/<%= encodeURIComponent(club.ClubName) %>/event/<%= encodeURIComponent(event._id) %>/edit-registration/<%= registration._id %>"
        method="POST"
        class="shadow p-4 rounded bg-white"
      >
        <% if(event.participationType === "team"){ %>
        <div class="mb-3">
          <label class="form-label fw-bold">Team Name</label>
          <input
            type="text"
            name="teamName"
            class="form-control form-control-sm"
            value="<%= registration.teamName %>"
            required
          />
        </div>
        <% } %>

        <h5 class="mt-4 mb-3">
          <% if(event.participationType === "team"){ %> Team Members <% } else {
          %> Your Details <% } %>
        </h5>

        <div id="teamMembersContainer">
          <% registration.teamMembers.forEach((member, idx) => { %>

          <div class="border rounded p-3 mb-3 team-member-card">
            <% if(event.participationType === "team"){ %>
            <div class="d-flex justify-content-between mb-2">
              <strong>Member <%= idx + 1 %></strong>
              <% if(idx > 0){ %>
              <button
                type="button"
                class="btn btn-danger btn-sm"
                onclick="removeMember(this)"
              >
                Remove
              </button>
              <% } %>
            </div>
            <% } %> <% event.formFields.forEach(field => { %> <% const safeKey =
            field.label.replace(/\s+/g, "_"); let value = ""; if (field.type ===
            "email" || field.label.toLowerCase().includes("email")) { value =
            member.email || ""; } else if (member.fields) { const fieldKeys =
            Array.from( member.fields instanceof Map ? member.fields.keys() :
            Object.keys(member.fields) ); const matchKey = fieldKeys.find(k =>
            k.toLowerCase() === field.label.toLowerCase() || k.toLowerCase() ===
            safeKey.toLowerCase() ); if (matchKey) { value = member.fields.get ?
            member.fields.get(matchKey) : member.fields[matchKey]; } } %>

            <div class="mb-3">
              <label class="form-label fw-bold"><%= field.label %></label>
              <input type="<%= field.type %>" class="form-control
              form-control-sm" name="teamMembers[<%= idx %>][<%= safeKey %>]"
              value="<%- value %>" <%= field.isRequired ? "required" : "" %> />
            </div>

            <% }) %>
          </div>

          <% }) %>
        </div>

        <% if(event.participationType === "team"){ %>
        <button
          type="button"
          id="addMemberBtn"
          class="btn btn-outline-primary btn-sm"
        >
          + Add Member
        </button>
        <% } %>

        <button type="submit" class="btn btn-success w-100 mt-4">
          Update Registration
        </button>
      </form>
    </div>
  </div>
</div>

<script>
  const formFields = <%- JSON.stringify(event.formFields) %>;
  let memberCount = <%= registration.teamMembers.length %>;
  const minMembers = <%= event.teamSize?.min || 1 %>;
  const maxMembers = <%= event.teamSize?.max || 1 %>;

  function removeMember(button){
    if(memberCount <= minMembers){
      alert("You must have at least " + minMembers + " members");
      return;
    }
    button.closest(".team-member-card").remove();
    memberCount--;
  }

  document.getElementById("addMemberBtn")?.addEventListener("click", () => {
    if(memberCount >= maxMembers){
      alert("Maximum team size reached!");
      return;
    }

    const idx = memberCount++;
    let html = `
      <div class="border rounded p-3 mb-3 team-member-card">
        <div class="d-flex justify-content-between mb-2">
          <strong>Member ${idx + 1}</strong>
          <button type="button" class="btn btn-danger btn-sm" onclick="removeMember(this)">Remove</button>
        </div>`;

    formFields.forEach(field => {
      const safeKey = field.label.replace(/\s+/g, "_");
      html += `
        <div class="mb-3">
          <label class="form-label fw-bold">${field.label}</label>
          <input
            type="${field.type}"
            class="form-control form-control-sm"
            name="teamMembers[${idx}][${safeKey}]"
            ${field.isRequired ? "required" : ""}
          />
        </div>`;
    });

    html += `</div>`;

    document.getElementById("teamMembersContainer").insertAdjacentHTML("beforeend", html);
  });
</script>
